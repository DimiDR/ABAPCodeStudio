name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:

  # ─── PYTHON TESTS ─────────────────────────────────────────
  test-backend:
    name: "Backend Tests"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: abap_studio_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports: ["5432:5432"]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r cloud-backend/requirements.txt
          pip install -r agent-sdk/requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/abap_studio_test
          PYTHONPATH: .
        run: |
          pytest tests/ -v --cov=cloud-backend --cov=agent-sdk --cov=shared --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml

  # ─── PYTHON LINT ──────────────────────────────────────────
  lint-backend:
    name: "Backend Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install ruff mypy
      - name: Ruff check
        run: ruff check cloud-backend/ agent-sdk/ shared/
      - name: Type check
        run: mypy shared/models/base.py --ignore-missing-imports

  # ─── FRONTEND BUILD ──────────────────────────────────────
  build-frontend:
    name: "Frontend Build"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install & Build
        working-directory: frontend
        run: |
          npm ci
          npm run build

  # ─── DOCKER BUILD ─────────────────────────────────────────
  build-docker:
    name: "Docker Build"
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build Cloud image
        run: docker build -f infra/Dockerfile.cloud -t abap-studio/cloud:latest .

      - name: Build Agent image
        run: docker build -f infra/Dockerfile.agent -t abap-studio/agent:latest .

      # In production: push to registry
      # - name: Push to registry
      #   run: |
      #     docker tag abap-studio/cloud:latest ghcr.io/your-org/abap-studio-cloud:latest
      #     docker push ghcr.io/your-org/abap-studio-cloud:latest

  # ─── DEPLOY (staging) ────────────────────────────────────
  deploy-staging:
    name: "Deploy Staging"
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to staging
        run: echo "Deploy to staging server via SSH / kubectl / terraform"
        # In production:
        # - SSH to server and docker-compose pull + up
        # - Or kubectl apply for K8s
        # - Or terraform apply for cloud infrastructure
